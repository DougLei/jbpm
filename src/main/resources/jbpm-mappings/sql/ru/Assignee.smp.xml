<?xml version="1.0" encoding="UTF-8"?>
<mapping-configuration>
	<sql namespace="Assignee">
	
		<!-- 查询指派的人员配置的委托信息 -->
		<content name="queryDelegations" type="select">
			select user_id, assigned_user_id, reason, procdef_code, procdef_version from bpm_re_delegation p
				left join bpm_re_delegation_detail s on (p.id = s.delegation_id)
					where p.is_enabled=1 and p.start_time &lt; #{currentTime, dataType=number, length=13} and p.end_time &gt; #{currentTime, dataType=number, length=13} and  
					<foreach collection="userIds" alias="userId" open="p.user_id in (" separator="," close=")">
						#{userId}
					</foreach>
		</content>
		
		<!-- 认领任务 -->
		<content name="claimTask" type="update">
			update bpm_ru_assignee set handle_state='CLAIMED', claim_time=#{claimTime, dataType=datetime} where 
			<foreach collection="assigneeIds" alias="assigneeId" open="id in (" separator="," close=")">
				#{assigneeId, dataType=number}
			</foreach>
		</content>
		
		<!-- 在认领任务时, 查询同组内有没有人已经认领 -->
		<content name="querySameGroupClaimed" type="select">
			select group_id from bpm_ru_assignee where taskinst_id=#{taskinstId} and mode &lt;&gt; 'ASSISTED' and handle_state = 'CLAIMED' and 
			<foreach collection="assigneeList" alias="assignee" open="group_id in (" separator="," close=")">
				#{assignee.groupId, dataType=number}
			</foreach> 
		</content>
		
		<!-- 在认领任务时, 查询任务指派信息的认领情况 -->
		<content name="queryAssigneeClaimSituation" type="select">
			select id, group_id, user_id, parent_user_id, handle_state from bpm_ru_assignee where taskinst_id=#{taskinstId} and mode &lt;&gt; 'ASSISTED' and handle_state in('UNCLAIM','CLAIMED')
			union all
			select id, group_id, user_id, parent_user_id, handle_state from bpm_hi_assignee where taskinst_id=#{taskinstId} and mode &lt;&gt; 'ASSISTED' and handle_state = 'FINISHED'
		</content>
		
		<!-- 在认领任务时, 将同组的指派信息的handleState改为INVALID -->
		<content name="handleState2Invalid" type="update">
			update bpm_ru_assignee set handle_state='INVALID' where taskinst_id=#{taskinstId} and handle_state &lt;&gt; 'INVALID' and 
			<foreach collection="groupIds" alias="groupId" open="group_id in (" separator="," close=")">
				#{groupId, dataType=number}
			</foreach> 
		</content>
		
		<!-- 取消认领任务 -->
		<content name="unclaimTask" type="update">
			update bpm_ru_assignee set handle_state='UNCLAIM', claim_time=null where 
			<foreach collection="assigneeList" alias="assignee" open="id in (" separator="," close=")">
				#{assignee.id, dataType=number}
			</foreach>
		</content>
		
		
		<!-- 根据groupId和parentUserId查询对应上一层的指派信息集合 -->
		<content name="queryParentAssigneeList" type="select">
			select * from bpm_ru_assignee where taskinst_id= #{taskinstId} and 
				<foreach collection="groupIds" alias="groupId" open="group_id in (" separator="," close=") ">
					#{groupId, dataType=number}
				</foreach>
				and 
				<foreach collection="assigneeList" alias="assignee" open="user_id in (" separator="," close=")">
					#{assignee.parentUserId}
				</foreach>
		</content>
		
		<!-- 删除指派信息 -->
		<content name="deleteAssigneeByGroupIds" type="delete">
			delete bpm_ru_assignee where taskinst_id= #{taskinstId} and 
			<foreach collection="groupIds" alias="groupId" open="group_id in (" separator="," close=")">
				#{groupId, dataType=number}
			</foreach>
		</content>
		
		<!-- 删除指派信息 -->
		<content name="deleteAssigneeByIds" type="delete">
			delete bpm_ru_assignee where 
			<foreach collection="assigneeList" alias="assignee" open="id in (" separator="," close=")">
				#{assignee.id, dataType=number}
			</foreach>
		</content>
	</sql>
</mapping-configuration>